<!doctype html>
<html lang="en">
<head>
	<title>My Map Test</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!-- Leaflet style. REQUIRED! -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
	<style>
		html { height: 100% }
		body { height: 100%; margin: 0; padding: 0;}
		.map { height: 100% }
	</style>
</head>
<body>
	 <div id="mapid" style="width: 100%; height: 100%;"></div>

	<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="token.js"></script>


	<script>
	    var pokemap = $.ajax({
          url:"map.json",
          dataType: "json",
          success: console.log("Pokemap data successfully loaded."),
		  error: function (xhr) {
            alert(xhr.statusText)
          }

        })
		$.when(pokemap).done(function(){
			var map = L.map('mapid').setView([42.44, -76.48], 12);
			map.setMaxBounds(map.getBounds());
			map.setView([42.44, -76.48], 14);
			map.options.minZoom = 12;

			var basic = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>, Icons made by <a href="https://theartificial.com" title="The Artificial">The Artificial</a>',
				maxZoom: 18,
				id: 'mapbox.streets',
				accessToken: mapBoxToken
			}).addTo(map);


			var collection = pokemap.responseJSON;

			var categories = {},
				category;

			var icons = {
				'Rare Candy': L.icon({iconUrl: "./img/rare_candy.png", iconSize: [30,30]}),
				'Gen 1 Starter': L.icon({iconUrl: "./img/001-bulbasaur.png", iconSize: [30,30]}),
				'Caterpie': L.icon({iconUrl: "./img/010-caterpie.png", iconSize: [30,30]}),
				'Clefable': L.icon({iconUrl: "./img/036-clefable.png", iconSize: [30,30]}),
				'Wigglytuff': L.icon({iconUrl: "./img/040-wigglytuff.png", iconSize: [30,30]}),
				'Golbat': L.icon({iconUrl: "./img/042-golbat.png", iconSize: [30,30]}),
				'Golduck': L.icon({iconUrl: "./img/055-golduck.png", iconSize: [30,30]}),
				'Mankey': L.icon({iconUrl: "./img/056-mankey.png", iconSize: [30,30]}),
				'Poliwag or Vulpix': L.icon({iconUrl: "./img/060-poliwag.png", iconSize: [30,30]}),
				'Machop': L.icon({iconUrl: "./img/066-machop.png", iconSize: [30,30]}),
				'Gastly': L.icon({iconUrl: "./img/092-gastly.png", iconSize: [30,30]}),
				'Onix': L.icon({iconUrl: "./img/095-onix.png", iconSize: [30,30]}),
				'Voltorb': L.icon({iconUrl: "./img/100-voltorb.png", iconSize: [30,30]}),
				'Exeggcute': L.icon({iconUrl: "./img/102-exeggcute.png", iconSize: [30,30]}),
				'Exeggcute or Lanturn': L.icon({iconUrl: "./img/102-exeggcute.png", iconSize: [30,30]}),
				'Chansey': L.icon({iconUrl: "./img/113-chansey.png", iconSize: [30,30]}),
				'Jynx': L.icon({iconUrl: "./img/124-jynx.png", iconSize: [30,30]}),
				'Electabuzz': L.icon({iconUrl: "./img/125-electabuzz.png", iconSize: [30,30]}),
				'Magmar': L.icon({iconUrl: "./img/126-magmar.png", iconSize: [30,30]}),
				'Pinsir': L.icon({iconUrl: "./img/127-pinsir.png", iconSize: [30,30]}),
				'Magikarp': L.icon({iconUrl: "./img/129-magikarp.png", iconSize: [30,30]}),
				'Eevee': L.icon({iconUrl: "./img/133-eevee.png", iconSize: [30,30]}),
				'Porygon': L.icon({iconUrl: "./img/137-porygon.png", iconSize: [30,30]}),
				'Dratini': L.icon({iconUrl: "./img/147-dratini.png", iconSize: [30,30]}),
				'Lanturn': L.icon({iconUrl: "./img/171-lanturn.png", iconSize: [30,30]}),
				'Misdreavus': L.icon({iconUrl: "./img/200-misdreavus.png", iconSize: [30,30]}),
				'Pineco': L.icon({iconUrl: "./img/204-pineco.png", iconSize: [30,30]}),
				'Larvitar': L.icon({iconUrl: "./img/246-larvitar.png", iconSize: [30,30]}),
				'Nincada': L.icon({iconUrl: "./img/290-nincada.png", iconSize: [30,30]}),
				'Nosepass': L.icon({iconUrl: "./img/299-nosepass.png", iconSize: [30,30]}),
				'Numel': L.icon({iconUrl: "./img/322-numel.png", iconSize: [30,30]}),
				'Spinda': L.icon({iconUrl: "./img/327-spinda-6.png", iconSize: [30,30]}),
				'Feebas': L.icon({iconUrl: "./img/349-feebas.png", iconSize: [30,30]}),
			}

			function onEachFeature(feature, layer) {
				// does this feature have a property named popupContent?
				if (feature.properties && feature.properties.Reward) {
					layer.bindPopup("<div><h3>" + feature.properties['Stop Name'] + "</h3>" + feature.properties.Task + " for a " + feature.properties.Reward +"</div>");
					if (feature.properties.Category == 'Encounter') {
						layer.setIcon(icons[feature.properties.Reward]);
						category = feature.properties.Reward;
					} else {
						layer.setIcon(icons[feature.properties.Category]);
						category = feature.properties.Category;
					}

				} else {
					category = 'Unreported';
					layer.bindPopup("<div><h3>" + feature.properties['Stop Name'] + "</h3></div>");
				}
				if (typeof categories[category] === "undefined") {
					categories[category] = [];
				}
				categories[category].push(layer);
			}

			var allPoints = L.geoJson(collection, {
				onEachFeature: onEachFeature
			});

			var basemapsObj = { 'Street View': basic};

			var overlaysObj = {},
				categoryName,
				categoryArray,
				categoryLG;

			categoryName = 'Unreported'
			categoryArray = categories[categoryName];
			if (Object.keys(categories).length == 1){
				categoryLG = L.layerGroup(categoryArray).addTo(map);
			} else {
			categoryLG = L.layerGroup(categoryArray);
			}
			categoryLG.categoryName = categoryName;
			overlaysObj[categoryName] = categoryLG;


			for (x in Object.keys(categories).sort()) {
				categoryName = Object.keys(categories).sort()[x]
				if (categoryName != 'Unreported'){
					categoryArray = categories[categoryName];
					categoryLG = L.layerGroup(categoryArray).addTo(map);
					categoryLG.categoryName = categoryName;
					overlaysObj[categoryName] = categoryLG;
				}
			}


			var control = L.control.layers(basemapsObj, overlaysObj, { collapsed: false }).addTo(map);

			// Make sure the Layers Control checkboxes are kept in sync with what is on map.
			// For some reason this control does not sync its checkboxes with the map state by itself, whereas it does with Leaflet 0.7.x?

		});
	</script>
</body>
</html>
