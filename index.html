<!doctype html>
<html lang="en">
<head>
	<title>My Map Test</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<!-- Leaflet style. REQUIRED! -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
	<style>
		html { height: 100% }
		body { height: 100%; margin: 0; padding: 0;}
		.map { height: 100% }
	</style>
</head>
<body>
	 <div id="mapid" style="width: 100%; height: 100%;"></div>	

	<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


	<script>
	    var pokemap = $.ajax({
          url:"https://gist.githubusercontent.com/mathmauney/a3ea787a3c2c1fb7ca0e2ea1ae5b7b2c/raw/b446ee0fa77c0043f78ca8f3ecaeab54c012660e/map.geojson",
          dataType: "json",
          success: console.log("Pokemap data successfully loaded."),
		  error: function (xhr) {
            alert(xhr.statusText)
          }

        })
		$.when(pokemap).done(function(){
			var map = L.map('mapid').setView([42.44, -76.48], 14);

			var basic = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>, Icons made by <a href="https://theartificial.com" title="The Artificial">The Artificial</a>',
				maxZoom: 18,
				id: 'mapbox.streets',
				accessToken: 'pk.eyJ1IjoibWF0aG1hdW5leSIsImEiOiJjam9icmc0OWYwN2ozM3BsZmV4a2szYm5zIn0.2VbfGiD5zv_Jed0r01fmpg'
			}).addTo(map);
			

			var collection = pokemap.responseJSON;

			var categories = {},
				category;
				
			var icons = {
				'Caterpie': L.icon({iconUrl: "./img/010-caterpie.png", iconSize: [30,30]}),
				'Spinda': L.icon({iconUrl: "./img/327-spinda-7.png", iconSize: [30,30]})
			}
			
			function onEachFeature(feature, layer) {
				// does this feature have a property named popupContent?
				if (feature.properties && feature.properties.Reward) {
					layer.bindPopup("<div><h3>" + feature.properties.Reward + "</h3>" + feature.properties.Task + "</div>");
					layer.setIcon(icons[feature.properties.Reward]);
					category = feature.properties.Reward;
				} else {
					category = 'Unreported'
				}
				if (typeof categories[category] === "undefined") {
					categories[category] = [];
				}
				categories[category].push(layer);				
			}	
				
			var allPoints = L.geoJson(collection, {
				onEachFeature: onEachFeature
			});

			var basemapsObj = { 'Street View': basic};

			var overlaysObj = {},
				categoryName,
				categoryArray,
				categoryLG;

			for (categoryName in categories) {
				categoryArray = categories[categoryName];
				categoryLG = L.layerGroup(categoryArray).addTo(map);
				categoryLG.categoryName = categoryName;
				overlaysObj[categoryName] = categoryLG;
			}


			var control = L.control.layers(basemapsObj, overlaysObj, { collapsed: false }).addTo(map);

			// Make sure the Layers Control checkboxes are kept in sync with what is on map.
			// For some reason this control does not sync its checkboxes with the map state by itself, whereas it does with Leaflet 0.7.x?
			
		});
	</script>
</body>
</html>
